graph TB
    subgraph "Host Computer System"
        subgraph CPU["CPU (Processor)"]
            CORES["CPU Cores<br/>Execute Programs"]
            MEMCTRL["Memory Controller<br/>(Routes addresses to DDR4 or devices)"]
            PCIECTRL["PCIe Root Complex<br/>(Routes PCIe packets)"]
        end

        subgraph SYSMEM["System Memory (DDR4 RAM)<br/>7-Layer Hierarchical Organization"]
            style SYSMEM fill:#e1f5ff

            subgraph L1["Layer 1: DIMM (Physical Module)"]
                DIMM["Memory Stick<br/>Plugs into motherboard<br/>Typically 8-64 GB total"]
            end

            subgraph L2["Layer 2: Rank (Physical Side)"]
                RANK["Rank 0 (Front) | Rank 1 (Back)<br/>Chips on each side of DIMM"]
            end

            subgraph L3["Layer 3: Chip (Individual IC)"]
                CHIP["8-16 chips per DIMM<br/>Each chip: 512 MB - 2 GB"]
            end

            subgraph L4["Layer 4: Bank (Parallel Sections)"]
                BANK["8 Banks per chip<br/>Can operate independently"]
            end

            subgraph L5["Layer 5: Row (Data Line)"]
                ROW["~65,000 rows per bank<br/>Each row: ~8 KB"]
                ROWBUF["Row Buffer (SRAM cache)<br/>Holds currently open row<br/>Fast access: ~10ns"]
            end

            subgraph L6["Layer 6: Column (Data Word)"]
                COL["~1,000 columns per row<br/>Selects specific bytes"]
            end

            subgraph L7["Layer 7: DRAM Cell (Storage Unit)"]
                CELL["1 Transistor + 1 Capacitor<br/>Stores 1 bit<br/>Charged=1, Discharged=0"]
            end

            DIMM --> RANK
            RANK --> CHIP
            CHIP --> BANK
            BANK --> ROW
            ROW --> ROWBUF
            ROWBUF --> COL
            COL --> CELL
        end

        subgraph BUFFERS["What System Memory Stores"]
            style BUFFERS fill:#fff4e1
            DMA_BUF["DMA Buffers<br/>Data staged for FPGA transfer<br/>Example: Command packets,<br/>network configurations"]
            CMD_BUF["Command Packets<br/>512-bit instructions<br/>Tell FPGA what to do"]
            DATA_BUF["Network Data<br/>Neuron configurations,<br/>synaptic weights before<br/>transfer to HBM"]
        end

        CORES -->|"CPU writes data<br/>(normal memory ops)"| MEMCTRL
        MEMCTRL -->|"DDR4 Protocol<br/>64-bit bus, raw signals<br/>~25 GB/s"| SYSMEM
        MEMCTRL -.->|"Routes PCIe<br/>transactions"| PCIECTRL
        SYSMEM -.->|"Stores"| BUFFERS
    end

    subgraph PCIE_BUS["PCIe Gen3 x16 Connection"]
        style PCIE_BUS fill:#ffe1e1
        TLPPKT["Transaction Layer Packets (TLPs)<br/>- Memory Read Request (FPGA → Host)<br/>- Memory Write (Host → FPGA)<br/>- Completion (Host → FPGA with data)<br/>Contains: Address, Length, Payload"]
    end

    subgraph FPGA_SYS["FPGA System"]
        PCIEBLK["PCIe Hard Block<br/>Sends/receives TLPs"]
        PCIE2FIFO["pcie2fifos Module<br/>Converts TLPs to FIFO ops"]
        INFIFO["Input FIFO<br/>Buffers commands from host"]
        OUTFIFO["Output FIFO<br/>Buffers results to host"]
        CMDINT["command_interpreter<br/>Processes commands"]
    end

    PCIECTRL <-->|"PCIe TLP packets<br/>~14 GB/s"| TLPPKT
    TLPPKT <-->|"16 lanes<br/>differential pairs"| PCIEBLK
    PCIEBLK --> PCIE2FIFO
    PCIE2FIFO --> INFIFO
    INFIFO --> CMDINT
    CMDINT -.->|"Reads commands"| INFIFO

    subgraph USAGE["Typical hs_bridge Workflow"]
        style USAGE fill:#e1ffe1
        STEP1["1. CPU (hs_api/hs_bridge)<br/>creates command packets<br/>in System Memory"]
        STEP2["2. CPU writes MMIO registers<br/>via PCIe to tell FPGA<br/>where buffers are located"]
        STEP3["3. FPGA becomes bus master<br/>Reads System Memory directly<br/>via DMA over PCIe"]
        STEP4["4. Memory Controller<br/>accesses DDR4 hierarchy<br/>Returns data in TLP packets"]
        STEP5["5. FPGA processes commands<br/>Writes results back to<br/>System Memory via DMA"]

        STEP1 --> STEP2
        STEP2 --> STEP3
        STEP3 --> STEP4
        STEP4 --> STEP5
    end

    classDef criticalPath fill:#ffcccc
    classDef dataPath fill:#ccf
    classDef controlPath fill:#cfc

    class MEMCTRL,PCIECTRL criticalPath
    class SYSMEM,BUFFERS dataPath
    class CMDINT,PCIE2FIFO controlPath
